
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Duck Stamp Vault</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0b5c3a" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <style>
    :root {
      --bg: #0b0c0f; --surface: #0f1115; --card: #11151a; --card-2: #0d1014;
      --text: #e7e9ee; --muted: #a6adbb; --border: #1b2230; --ring: #78e2a0;
      --accent: #20c997; --accent-2: #14b78a; --danger: #e35d6a;
      --shadow: 0 10px 30px rgba(0,0,0,.35); --radius: 14px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg:#f4f6f8; --surface:#fff; --card:#fff; --card-2:#f8fafc; --text:#0f172a;
        --muted:#5b6471; --border:#e6e9ef; --ring:#1a7f63; --accent:#0ea5a0; --accent-2:#0c8f8b; --danger:#b3261e;
        --shadow: 0 6px 18px rgba(16,24,40,.08);
      }
    }
    :root[data-theme="light"] { color-scheme: light; }
    :root[data-theme="dark"]  { color-scheme: dark; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% -10%, #1a2a24 0%, transparent 50%),
                  radial-gradient(900px 700px at 120% 10%, #1c2340 0%, transparent 55%), var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .app { max-width: 1120px; margin: 0 auto; padding: 28px; }
    .topbar {
      position: sticky; top: 0; z-index: 10;
      background: color-mix(in oklab, var(--surface) 80%, transparent);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow); padding: 10px 14px; margin-bottom: 18px;
      display: flex; align-items: center; gap: 12px;
    }
    .brand { display:flex; align-items:center; gap:10px; padding:6px 10px; border-radius:12px;
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 80%, transparent), var(--card-2));
      border:1px solid var(--border);
    }
    .brand .logo { font-size: 22px; }
    .brand .title { font-weight: 700; letter-spacing: .2px; }
    .spacer { flex: 1; }
    .icon-btn { background: var(--card); color: var(--text); border: 1px solid var(--border);
      padding: 8px 12px; border-radius: 10px; cursor: pointer; }
    .icon-btn:hover { border-color: color-mix(in oklab, var(--border), var(--accent)); }
    .grid { display: grid; gap: 16px; }
    .grid.cols-3 { grid-template-columns: 1.1fr .9fr; }
    @media (min-width: 980px) { .grid.cols-3 { grid-template-columns: 1.15fr .85fr; } }
    .card { background: linear-gradient(180deg, var(--card), var(--card-2));
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 18px; }
    .card > h2 { margin: 0 0 12px; font-size: 18px; letter-spacing:.2px; display:flex; align-items:center; gap:10px; }
    .chip { display:inline-flex; gap:6px; align-items:center; padding:2px 8px; background: color-mix(in oklab, var(--accent) 18%, var(--card)); color: var(--text);
      border:1px solid color-mix(in oklab, var(--accent) 32%, var(--border)); border-radius: 999px; font-size: 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    .field { position: relative; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 12px 12px 12px 38px; border-radius: 12px; border: 1px solid var(--border); outline: none; color: var(--text);
      background: linear-gradient(180deg, var(--surface), color-mix(in oklab, var(--surface) 85%, black 5%)); transition: border-color .15s, box-shadow .15s;
    }
    .field textarea { min-height: 84px; resize: vertical; }
    .field:focus-within input,.field:focus-within select,.field:focus-within textarea {
      border-color: color-mix(in oklab, var(--accent) 55%, var(--border)); box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 25%, transparent);
    }
    .field .ico { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 16px; pointer-events: none; }
    .row { display:grid; gap: 12px; }
    .row.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .row.cols-3 { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 820px){ .row.cols-2, .row.cols-3 { grid-template-columns: 1fr; } }
    .btn { background: linear-gradient(180deg, var(--accent), var(--accent-2)); color: white; border: 0; padding: 10px 14px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn.secondary { background: linear-gradient(180deg, var(--surface), var(--card)); color: var(--text); border: 1px solid var(--border); }
    .btn.danger { background: linear-gradient(180deg, var(--danger), color-mix(in oklab, var(--danger) 70%, black)); }
    .btn:focus-visible { outline: 3px solid color-mix(in oklab, var(--accent) 40%, transparent); outline-offset: 2px; }
    .drop { border: 1.5px dashed color-mix(in oklab, var(--border), var(--accent) 20%); border-radius: 14px; padding: 16px; text-align: center;
      background: linear-gradient(180deg, color-mix(in oklab, var(--card) 80%, transparent), var(--card-2)); color: var(--muted); }
    .drop.drag { border-color: var(--accent); color: var(--accent); }
    .preview { margin-top: 10px; display:flex; gap:10px; flex-wrap:wrap }
    .preview img { width: 120px; height: 90px; object-fit: cover; border-radius: 10px; border:1px solid var(--border); }
    .stamp-card { display:flex; gap: 14px; align-items:flex-start; border: 1px solid var(--border); border-radius: 14px; padding: 12px;
      background: linear-gradient(180deg, var(--surface), var(--card)); }
    .thumb { width: 120px; height: 90px; object-fit: cover; border-radius: 10px; border:1px solid var(--border); background:#0a0c10; }
    .meta { flex: 1; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border:1px solid var(--border); background: color-mix(in oklab, var(--card) 70%, var(--accent) 10%); margin-right:6px; font-size:12px; color: var(--text) }
    .toolbar { display:flex; gap:12px; flex-wrap: wrap; align-items:end; }
    .totals { color: var(--muted); margin-top: 6px; }
    canvas { width: 100%; height: 180px; display:block; border-radius: 12px; background: linear-gradient(180deg, var(--surface), var(--card)); border: 1px solid var(--border); }
    .toast { position: fixed; right: 18px; bottom: 18px; z-index: 9999; background: var(--card); border:1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: 10px 12px; display:none; }

    /* Emoji-safe select spacing */
    .field select { padding-left: 44px !important; height: 42px; min-width: 190px; appearance: none;
      background-position: right 10px center; background-repeat: no-repeat; background-size: 12px auto; }
    .field .ico { width: 24px; text-align: center; }
  
/* Router views */
.view { display: none; }
.view.active { display: block; }
.app-header {
  position: sticky; top: 0; z-index: 15;
  background: color-mix(in oklab, var(--surface) 85%, transparent);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
  border-radius: calc(var(--radius) + 6px);
  padding: 10px 14px; margin-bottom: 16px;
  display:flex; align-items:center; gap:10px;
}
.app-header .brand { background: none; border: none; box-shadow: none; padding:0; }
.app-footer { text-align:center; margin: 18px 0 8px; color: var(--muted); }
.hero-btn { height: 64px; font-size: 17px; }
.hero-row { display:grid; gap:14px; grid-template-columns: 1fr; }
@media (min-width: 720px){ .hero-row { grid-template-columns: repeat(3, 1fr); } }
.big-card { border:1px solid var(--border); border-radius:16px; overflow:hidden; background: linear-gradient(180deg, var(--surface), var(--card)); box-shadow: var(--shadow); }
.big-card img { width:100%; height: 200px; object-fit: cover; display:block; }
.big-card .meta { padding: 12px 14px; }
.nav-btn { background: var(--card); border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer; }
.nav-btn:hover { border-color: color-mix(in oklab, var(--border), var(--accent)); }

  </style>
</head>
<body>

<div class="app">
  <!-- Splash Overlay (unchanged) -->
  <div id="splash" style="position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center; z-index:1000; transition:opacity .35s;">
    <div style="text-align:center">
      <div style="width:96px; height:96px; margin:0 auto 12px; border-radius:24px; overflow:hidden; border:1px solid var(--border); box-shadow: var(--shadow); background:linear-gradient(180deg, var(--surface), var(--card))">
        <img src="icons/icon-192.png" alt="icon" width="96" height="96" style="width:100%; height:100%; object-fit:cover;">
      </div>
      <div style="font-weight:800; font-size:22px">Duck Stamp Vault</div>
      <div style="color:var(--muted)">Loading‚Ä¶</div>
    </div>
  </div>

  <!-- Global Header -->
  <div class="app-header">
    <div class="brand">
      <div class="logo">ü¶Ü</div>
      <div class="title">Duck Stamp Vault</div>
      <span class="chip">v6</span>
    </div>
    <div class="spacer"></div>
    <button class="nav-btn" onclick="go('#/menu')" title="Home">üè†</button>
    <button class="nav-btn" onclick="go('#/collection')" title="Collection">üóÇÔ∏è</button>
    <button class="nav-btn" onclick="go('#/add')" title="Add">‚ûï</button>
    <button class="nav-btn" onclick="go('#/value')" title="Value">üìä</button>
    <button class="nav-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>

  <!-- VIEW: MENU -->
  <main id="view-menu" class="view active">
    <section class="card">
      <header style="display:flex; align-items:center; gap:12px; margin-bottom:10px">
        <div style="font-size:26px">ü¶Ü</div>
        <div style="font-weight:800; font-size:22px">Duck Stamp Vault</div>
        <span class="chip">Main Menu</span>
      </header>
      <div class="totals" style="margin-top:-4px; margin-bottom:12px">Choose an option to get started.</div>
      <div class="hero-row">
        <button class="btn hero-btn" onclick="go('#/collection')">üóÇÔ∏è View my Collection</button>
        <button class="btn hero-btn" onclick="go('#/add')">‚ûï Add a stamp</button>
        <button class="btn hero-btn" onclick="go('#/value')">üíπ Value my Collection</button>
      </div>
      <div class="hero-row" style="margin-top:12px">
        <button class="btn secondary hero-btn" onclick="go('#/buy')">üõí Buy a Federal Duck Stamp</button>
        <button class="btn secondary hero-btn" onclick="go('#/about')">‚ÑπÔ∏è About Us</button>
        <button class="btn secondary hero-btn" onclick="exportJSON()">‚¨áÔ∏è Export</button>
      </div>
    </section>
  </main>

  <!-- VIEW: COLLECTION -->
  <main id="view-collection" class="view">
    <section class="card">
      <h2>My Collection</h2>
      <div id="collectionList"></div>
      <div id="totals" class="totals"></div>
    </section>
  </main>

  <!-- VIEW: ADD -->
  <main id="view-add" class="view">
    <section class="card">
      <h2>Add / Edit</h2>
      <label>Image</label>
      <div id="drop" class="drop">
        <input type="file" id="img" accept="image/*" style="display:none">
        <div>Drag & drop image here or <button class="btn secondary" type="button" onclick="byId('img').click()">Choose</button></div>
        <div id="preview" class="preview"></div>
      </div>

      <div class="row cols-3" style="margin-top:8px">
        <div><label>Year</label><div class="field"><span class="ico">üìÖ</span><input type="number" id="year" min="1934" max="2100" placeholder="e.g., 1959"></div></div>
        <div><label>Face Value</label><div class="field"><span class="ico">üè∑Ô∏è</span><input type="number" id="faceValue" step="0.01" min="0" placeholder="25.00"></div></div>
        <div><label>Purchase Price</label><div class="field"><span class="ico">üíµ</span><input type="number" id="price" step="0.01" min="0" placeholder="40.00"></div></div>
      </div>

      <div class="row cols-3">
        <div><label>Estimated Value</label><div class="field"><span class="ico">üìà</span><input type="number" id="estValue" step="0.01" min="0" placeholder="Optional"></div></div>
        <div><label>Purchase Date</label><div class="field"><span class="ico">üóìÔ∏è</span><input type="date" id="purchaseDate"></div></div>
        <div><label>Condition</label><div class="field"><span class="ico">‚≠ê</span>
          <select id="condition">
            <option value="">Select‚Ä¶</option>
            <option>Mint</option><option>Mint NH</option><option>Hinged</option>
            <option>Used/Signed</option><option>Plate Block</option><option>Artist Signed</option>
            <option>Other</option>
          </select></div></div>
      </div>

      <div class="row cols-3">
        <div><label>Signature Type</label><div class="field"><span class="ico">‚úçÔ∏è</span>
          <select id="signatureType"><option value="">None</option><option>Artist</option><option>Hunter</option></select></div></div>
        <div><label>Acquisition Source</label><div class="field"><span class="ico">üè¨</span>
          <select id="acq">
            <option value="">Select‚Ä¶</option>
            <option>Amplex / duckstamp.com</option><option>USPS</option><option>National Wildlife Refuge</option>
            <option>Dealer / Show</option><option>Private Sale</option><option>Other</option>
          </select></div></div>
        <div><label>Scott #</label><div class="field"><span class="ico">üîé</span><input id="scott" placeholder="e.g., RW26"></div></div>
      </div>

      <div class="row cols-2">
        <div><label>Artist</label><div class="field"><span class="ico">üé®</span><input id="artist" placeholder="e.g., Maynard Reece"></div></div>
        <div><label>Species</label><div class="field"><span class="ico">ü¶Ü</span><input id="species" placeholder="e.g., Canvasbacks"></div></div>
      </div>

      <div class="row cols-2">
        <div><label>Plate/Position</label><div class="field"><span class="ico">üß©</span><input id="platePos" placeholder="UL, LL‚Ä¶"></div></div>
        <div><label>Notes</label><div class="field"><span class="ico">üìù</span><textarea id="notes" placeholder="Provenance, varieties, margin inscriptions‚Ä¶"></textarea></div></div>
      </div>

      <div style="display:flex; align-items:center; gap:12px; margin-top:12px">
        <label style="display:flex; align-items:center; gap:8px; font-size:13px; color:var(--muted)"><input id="autoFillToggle" type="checkbox" checked> Auto‚Äëfill from catalog</label>
        <button class="btn" id="submitBtn" onclick="handleSubmit()">Add</button>
        <button class="btn secondary" type="button" onclick="resetForm()">Reset</button>
      </div>
    </section>
  </main>

  <!-- VIEW: VALUE/STATS -->
  <main id="view-value" class="view">
    <section class="card">
      <h2>Collection Value</h2>
      <canvas id="chart" height="180"></canvas>
      <div id="chartSummary" class="totals"></div>
    </section>
  </main>

  <!-- VIEW: BUY -->
  <main id="view-buy" class="view">
    <section class="card">
      <h2>Buy a Federal Duck Stamp</h2>
      <p class="totals">Producer: <b>U.S. Fish & Wildlife Service</b>. Online sales: <b>Amplex Corporation</b> (duckstamp.com). Also at many USPS counters and National Wildlife Refuges.</p>
      <div class="row cols-2">
        <a class="btn" href="https://www.duckstamp.com/" target="_blank" rel="noopener">Go to duckstamp.com ‚Üí</a>
        <a class="btn secondary" href="https://www.usps.com/shop/duck-stamps.htm" target="_blank" rel="noopener">Buy at USPS ‚Üí</a>
      </div>
    </section>
  </main>

  <!-- VIEW: ABOUT -->
  <main id="view-about" class="view">
    <section class="card">
      <h2>About Duck Stamp Vault</h2>
      <p class="totals">An offline-first PWA for cataloging your U.S. Federal Duck Stamp collection. Not affiliated with USFWS/USPS/Amplex.</p>
      <p class="totals">Data is stored locally on your device (IndexedDB). Use Export/Import to back up or move devices.</p>
    </section>
  </main>

  <div class="app-footer">¬© <span id="yearNow"></span> Duck Stamp Vault ‚Ä¢ PWA ‚Ä¢ Offline-ready</div>
</div>


  <script>
    
// --- Simple hash router ---
const VIEWS = ['menu','collection','add','value','buy','about'];
function go(hash){ location.hash = hash; }
function showView(name){
  for (const v of VIEWS){
    const el = byId('view-' + v);
    if (el) el.classList.toggle('active', v === name);
  }
  // On entering certain views, refresh their contents
  if (name === 'collection') renderCollection();
  if (name === 'value') renderChart();
}
function route(){
  const h = location.hash.replace(/^#\/?/, '');
  const name = VIEWS.includes(h) ? h : 'menu';
  showView(name);
}
window.addEventListener('hashchange', route);

    // PWA + install
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js'));
    }
    let deferredPrompt=null; const installBtn=document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt=e; if (installBtn) installBtn.style.display='inline-block'; });
    installBtn?.addEventListener('click', async ()=>{ if (!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.style.display='none'; deferredPrompt=null; });

    // Theme toggle
    const root = document.documentElement;
    const savedTheme = localStorage.getItem('theme'); if (savedTheme) root.setAttribute('data-theme', savedTheme);
byId('year')?.addEventListener('change', e=> applyAutofillForYear(Number(e.target.value)));
// Ensure toggle respects saved setting
const savedAuto = localStorage.getItem('autoFill');
if (savedAuto !== null && byId('autoFillToggle')) byId('autoFillToggle').checked = savedAuto === 'true';
byId('autoFillToggle')?.addEventListener('change', e=> localStorage.setItem('autoFill', e.target.checked ? 'true':'false'));
    document.getElementById('themeBtn').addEventListener('click', ()=>{
      const next = (root.getAttribute('data-theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')) === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next); localStorage.setItem('theme', next);
    });

    // Utils

// --- Reference catalog (seed) ---
let REF = new Map([
  [1934, {artist:`J.N. "Ding" Darling`, species:`Mallards`, face:1.00}],
  [1959, {artist:`Maynard Reece`, species:`King Eiders`, face:3.00}],
  [1991, {artist:`Robert Steiner`, species:`Snow Geese`, face:25.00}],
  [2020, {artist:`James Hautman`, species:`Black-bellied Whistling-Ducks`, face:25.00}]
]);
async function tryLoadExternalCatalog(){
  try {
    const res = await fetch('./catalog.json', {cache:'no-store'});
    if (!res.ok) return;
    const arr = await res.json();
    if (Array.isArray(arr)) {
      for (const row of arr) if (row && row.year) REF.set(Number(row.year), {
        artist: row.artist || '', species: row.species || '', face: isFinite(row.face) ? Number(row.face) : undefined
      });
    }
  } catch {}
}
// Compute Scott# from year: RW1 => 1934
const scottFromYear = y => Number.isFinite(y) && y>=1934 ? `RW${y - 1933}` : '';
function applyAutofillForYear(y){
}

// --- Splash / Menu / Settings ---
function goToSection(key){
  const top = {
    new: 0,
    stats: document.getElementById('chart')?.getBoundingClientRect().top + window.scrollY - 20,
    collection: document.getElementById('stampGallery')?.getBoundingClientRect().top + window.scrollY - 20
  }[key] ?? 0;
  window.scrollTo({ top, behavior: 'smooth' });
  byId('menuDialog').close();
}

function openSettings(){
  // sync current state to UI
  byId('settingAutoFill').checked = !!byId('autoFillToggle')?.checked;
  byId('settingSplash').checked = localStorage.getItem('showSplash') !== 'false';
  byId('settingStartMenu').checked = localStorage.getItem('startOnMenu') === 'true';
  byId('settingsDialog').showModal();
}
function saveSettings(){
  const autoFill = byId('settingAutoFill').checked;
  const splash = byId('settingSplash').checked;
  const startMenu = byId('settingStartMenu').checked;
  if (byId('autoFillToggle')) byId('autoFillToggle').checked = autoFill;
  localStorage.setItem('showSplash', splash ? 'true' : 'false');
  localStorage.setItem('startOnMenu', startMenu ? 'true' : 'false');
  toast('Settings saved ‚öôÔ∏è');
  byId('settingsDialog').close();
}
function about(){ alert('Duck Stamp Vault\\nOffline-first PWA for tracking your federal duck stamp collection.'); }

  const on = document.getElementById('autoFillToggle')?.checked;
  if (!on) return;
  const sc = scottFromYear(y);
  const scEl = byId('scott');
  if (sc && scEl && !scEl.value) scEl.value = sc;
  const row = REF.get(Number(y));
  if (row){
    if (row.face && !byId('faceValue').value) byId('faceValue').value = row.face;
    if (row.artist && !byId('artist').value) byId('artist').value = row.artist;
    if (row.species && !byId('species').value) byId('species').value = row.species;
  }
}

    const USD = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });
    const fmtDate = d => d ? new Date(d).toLocaleDateString() : '‚Äî';
    const byId = id => document.getElementById(id);
    const escapeHTML = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    let editingId = null;

    // IndexedDB
    const DB_NAME = 'duckStampScrapbook'; const DB_VERSION = 2; let dbPromise=null;
    function openDB(){ if (dbPromise) return dbPromise; dbPromise=new Promise((resolve,reject)=>{
      const req=indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains('stamps')){const store=db.createObjectStore('stamps',{keyPath:'id'}); store.createIndex('addedAt','addedAt'); store.createIndex('year','year');}
        if(!db.objectStoreNames.contains('images')) db.createObjectStore('images',{keyPath:'id'});};
      req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error);
    }); return dbPromise;}
    async function tx(store,mode='readonly'){ const db=await openDB(); return db.transaction(store,mode).objectStore(store); }
    const reqProm=req=>new Promise((res,rej)=>{ req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); });
    async function put(store,val){ return reqProm((await tx(store,'readwrite')).put(val)); }
    async function get(store,key){ return reqProm((await tx(store)).get(key)); }
    async function del(store,key){ return reqProm((await tx(store,'readwrite')).delete(key)); }
    async function getAll(store){ return reqProm((await tx(store)).getAll()); }

    // Images
    async function storeImage(file){ const id=crypto.randomUUID(); await put('images',{id,blob:file}); return id; }
    async function getImageURL(imageId){ if(!imageId) return ''; const rec=await get('images', imageId); return rec ? URL.createObjectURL(rec.blob) : ''; }

    const drop = byId('drop'), fileIn = byId('img'), preview = byId('preview');
    const setPreview = async (file) => { preview.innerHTML=''; if(!file) return; const url=URL.createObjectURL(file); const img=new Image(); img.src=url; img.onload=()=>URL.revokeObjectURL(url); preview.appendChild(img); };
    ['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.add('drag');}));
    ['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault(); drop.classList.remove('drag');}));
    drop.addEventListener('drop', e=>{ const f=e.dataTransfer.files[0]; if(!f) return; fileIn.files=e.dataTransfer.files; setPreview(f); });
    fileIn.addEventListener('change', e=>setPreview(e.target.files[0]));

    // CRUD
    async function handleSubmit(){
      const y=Number((byId('year').value||'').trim()); if(!y||y<1934||y>2100) return toast("Enter a valid year (1934‚Äì2100).");
      const data = { id: editingId || crypto.randomUUID(), addedAt: editingId ? (await get('stamps', editingId))?.addedAt || Date.now() : Date.now(),
        year:y, faceValue:+byId('faceValue').value||0, price:+byId('price').value||0, estValue:+byId('estValue').value||0,
        purchaseDate: byId('purchaseDate').value || null, condition: byId('condition').value || '',
        signatureType: byId('signatureType').value || '', acquisition: byId('acq').value || '',
        artist:(byId('artist').value||'').trim(), species:(byId('species').value||'').trim(),
        scott:(byId('scott').value||'').trim(), platePos:(byId('platePos').value||'').trim(),
        notes:(byId('notes').value||'').trim() };
      const file=fileIn.files[0]; if(!editingId && !file) return toast("Please add an image."); if(file) data.imageId=await storeImage(file);
      await put('stamps', data); editingId=null; byId('submitBtn').textContent='Add'; resetForm(); renderCollection(); renderChart();
      // If first run (no stamps), show onboarding
      getAll('stamps').then(list => { if (!list || list.length === 0) { byId('firstRunDialog')?.showModal(); } }); toast('Saved ‚úÖ');
    }
    function resetForm(){ for (const id of ['img','year','faceValue','price','estValue','purchaseDate','condition','signatureType','acq','artist','species','scott','platePos','notes']){ const el=byId(id); if(!el) continue; el.value=''; }
      preview.innerHTML=''; editingId=null; byId('submitBtn').textContent='Add'; }
    async function editStamp(id){ const s=await get('stamps', id); if(!s) return; editingId=id;
      byId('year').value=s.year||''; byId('faceValue').value=s.faceValue??''; byId('price').value=s.price??''; byId('estValue').value=s.estValue??'';
      byId('purchaseDate').value=s.purchaseDate??''; byId('condition').value=s.condition||''; byId('signatureType').value=s.signatureType||''; byId('acq').value=s.acquisition||'';
      byId('artist').value=s.artist||''; byId('species').value=s.species||''; byId('scott').value=s.scott||''; byId('platePos').value=s.platePos||''; byId('notes').value=s.notes||'';
      byId('submitBtn').textContent='Save Changes'; window.scrollTo({ top:0, behavior:'smooth' }); }
    async function deleteStamp(id){ if(!confirm("Remove this stamp from your scrapbook?")) return; const s=await get('stamps', id); if(s?.imageId) await del('images', s.imageId);
      await del('stamps', id); renderCollection(); renderChart();
      // If first run (no stamps), show onboarding
      getAll('stamps').then(list => { if (!list || list.length === 0) { byId('firstRunDialog')?.showModal(); } }); toast('Deleted üóëÔ∏è'); }

    // Export / Import
    async function exportJSON(){ const stamps=await getAll('stamps'); const blob=new Blob([JSON.stringify(stamps,null,2)],{type:'application/json'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='duck-stamp-scrapbook.json'; a.click(); URL.revokeObjectURL(a.href); }
    async function importJSON(evt){ const file=evt.target.files?.[0]; if(!file) return; try { const data=JSON.parse(await file.text()); if(!Array.isArray(data)) throw new Error('Invalid format');
        for(const s of data) await put('stamps', s); toast('Import complete üì•'); renderCollection(); renderChart();
      // If first run (no stamps), show onboarding
      getAll('stamps').then(list => { if (!list || list.length === 0) { byId('firstRunDialog')?.showModal(); } });
      } catch(e){ toast('Import failed: '+e.message); } evt.target.value=''; }

    // Gallery + Chart

async function renderCollection(){
  const list = await getAll('stamps');
  const wrap = byId('collectionList');
  const sortBy = 'addedDesc';
  let arr = [...list];
  arr.sort((a,b)=> (b.addedAt||0)-(a.addedAt||0));

  wrap.innerHTML = '';

  if (!arr.length){
    wrap.innerHTML = '<div class="totals">No stamps yet. Use ‚ÄúAdd a stamp‚Äù from the menu to create your first entry.</div>';
    byId('totals').textContent = '';
    return;
  }

  let totalSpend = 0, totalEst = 0;
  for (const s of arr){
    totalSpend += Number(s.price||0);
    totalEst += Number(s.estValue||0);
    const url = await getImageURLSafe(s.imageId);
    const node = document.createElement('div');
    node.className = 'big-card';
    node.innerHTML = `
      <img src="${url}" alt="Stamp ${s.year||''}">
      <div class="meta">
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <div style="font-weight:700; font-size:18px">${s.year||'‚Äî'}</div>
          ${s.scott ? `<span class="pill">${escapeHTML(s.scott)}</span>` : ''}
          ${s.species ? `<span class="pill">${escapeHTML(s.species)}</span>` : ''}
          ${s.artist ? `<span class="pill">Artist: ${escapeHTML(s.artist)}</span>` : ''}
        </div>
        <div style="margin-top:4px; color:var(--muted)">
          <b>Condition:</b> ${escapeHTML(s.condition||'‚Äî')}
          ${s.signatureType ? ` ‚Ä¢ <b>Signature:</b> ${escapeHTML(s.signatureType)}`:''}
        </div>
        <div style="margin-top:4px">
          <b>Face:</b> ${isFinite(s.faceValue)?USD.format(s.faceValue):'‚Äî'}
          ‚Ä¢ <b>Paid:</b> ${USD.format(s.price||0)}
          ‚Ä¢ <b>Est:</b> ${s.estValue?USD.format(s.estValue):'‚Äî'}
        </div>
        <div style="margin-top:4px; color:var(--muted)">
          <b>Acquired:</b> ${escapeHTML(s.acquisition||'‚Äî')} ‚Ä¢ <b>Date:</b> ${fmtDate(s.purchaseDate)}
          ${s.platePos ? ` ‚Ä¢ <b>Plate/Pos:</b> ${escapeHTML(s.platePos)}`:''}
        </div>
        ${s.notes ? `<div style="margin-top:6px">${escapeHTML(s.notes)}</div>`:''}
        <div style="display:flex; gap:8px; margin-top:10px">
          <button class="btn secondary" onclick="editStamp('${s.id}'); go('#/add')">Edit</button>
          <button class="btn danger" onclick="deleteStamp('${s.id}').then(()=>renderCollection())">Delete</button>
        </div>
      </div>`;
    wrap.appendChild(node);
  }

  byId('totals').textContent = `Items: ${arr.length} ‚Ä¢ Total Spend: ${USD.format(totalSpend)} ‚Ä¢ Total Est. Value: ${USD.format(totalEst)} ‚Ä¢ Œî: ${USD.format(totalEst - totalSpend)}`;
}


    async function getImageURLSafe(imageId){ try { return await getImageURL(imageId); } catch { return ''; } }
        async function renderChart(){
      const stamps = await getAll('stamps');
      const c = byId('chart'), ctx = c.getContext('2d');
      const W = c.width = c.clientWidth * devicePixelRatio;
      const H = c.height = c.clientHeight * devicePixelRatio;
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
      ctx.clearRect(0,0,W,H);

      if (!stamps.length) { byId('chartSummary').textContent=''; return; }

      const pts = stamps
        .map(s => ({ date: s.purchaseDate ? new Date(s.purchaseDate) : new Date(s.addedAt||Date.now()), paid:+(s.price||0), est:+(s.estValue||0) }))
        .sort((a,b)=>a.date-b.date);

      const months = new Map();
      for (const p of pts){
        const k = `${p.date.getFullYear()}-${String(p.date.getMonth()+1).padStart(2,'0')}`;
        const cur = months.get(k) || { spend:0, est:0 };
        cur.spend += p.paid; cur.est += p.est; months.set(k, cur);
      }
      let cumSpend=0, cumEst=0; const series=[];
      for (const [k,v] of [...months.entries()].sort()){
        cumSpend += v.spend; cumEst += v.est; series.push({ label:k, spend:cumSpend, est:cumEst });
      }

      const padL=56, padR=16, padT=16, padB=28;
      const iW = (W/devicePixelRatio)-padL-padR, iH = (H/devicePixelRatio)-padT-padB;
      const maxY = Math.max(10, ...series.map(s=>Math.max(s.spend, s.est)));
      const x = i => padL + (series.length<=1 ? iW/2 : (i/(series.length-1))*iW);
      const y = v => padT + iH - (v/maxY)*iH;

      // grid
      ctx.strokeStyle = 'rgba(200,200,200,.15)'; ctx.lineWidth = 1;
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#999';
      ctx.font = '12px system-ui';
      for (let i=0;i<=4;i++){
        const yy = padT + (i/4)*iH; ctx.beginPath(); ctx.moveTo(padL, yy); ctx.lineTo(padL+iW, yy); ctx.stroke();
        const val = maxY * (1 - i/4); ctx.fillText(new Intl.NumberFormat().format(Math.round(val)), 8, yy+4);
      }

      const spendColor = '#e35d6a';
      const estColor = '#20c997';

      if (series.length === 1) {
        const s = series[0]; const xx = x(0); const ys = y(s.spend), ye = y(s.est);
        ctx.fillStyle = spendColor; ctx.beginPath(); ctx.arc(xx, ys, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = estColor; ctx.beginPath(); ctx.arc(xx, ye, 4, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#111';
        ctx.fillText(new Intl.NumberFormat().format(Math.round(s.spend)), xx+8, ys-6);
        ctx.fillText(new Intl.NumberFormat().format(Math.round(s.est)), xx+8, ye-6);
      } else {
        // spend path + fill + markers
        ctx.beginPath();
        series.forEach((s,i)=>{ const xx=x(i), yy=y(s.spend); i?ctx.lineTo(xx,yy):ctx.moveTo(xx,yy); });
        ctx.strokeStyle = spendColor; ctx.lineWidth = 2.4; ctx.stroke();
        ctx.lineTo(padL+iW, padT+iH); ctx.lineTo(padL, padT+iH); ctx.closePath();
        let gradS = ctx.createLinearGradient(0, padT, 0, padT+iH); gradS.addColorStop(0, spendColor+'33'); gradS.addColorStop(1, spendColor+'00');
        ctx.fillStyle = gradS; ctx.fill();
        ctx.fillStyle = spendColor; series.forEach((s,i)=>{ const xx=x(i), yy=y(s.spend); ctx.beginPath(); ctx.arc(xx, yy, 3, 0, Math.PI*2); ctx.fill(); });

        // est path + fill + markers
        ctx.beginPath();
        series.forEach((s,i)=>{ const xx=x(i), yy=y(s.est); i?ctx.lineTo(xx,yy):ctx.moveTo(xx,yy); });
        ctx.strokeStyle = estColor; ctx.lineWidth = 2.4; ctx.stroke();
        ctx.lineTo(padL+iW, padT+iH); ctx.lineTo(padL, padT+iH); ctx.closePath();
        let gradE = ctx.createLinearGradient(0, padT, 0, padT+iH); gradE.addColorStop(0, estColor+'33'); gradE.addColorStop(1, estColor+'00');
        ctx.fillStyle = gradE; ctx.fill();
        ctx.fillStyle = estColor; series.forEach((s,i)=>{ const xx=x(i), yy=y(s.est); ctx.beginPath(); ctx.arc(xx, yy, 3, 0, Math.PI*2); ctx.fill(); });
      }

      // x labels
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#999';
      const labs = [0, Math.floor(series.length/2), series.length-1];
      new Set(labs).forEach(i=>{ if (i<0 || i>=series.length) return; const xx = x(i); ctx.fillText(series[i].label, xx-18, padT+iH+18); });

      // legend
      const legendX = padL + iW - 150, legendY = padT + 6;
      ctx.strokeStyle = spendColor; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(legendX, legendY); ctx.lineTo(legendX+16, legendY); ctx.stroke();
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text') || '#111';
      ctx.fillText('Spend', legendX+22, legendY+4);
      ctx.strokeStyle = estColor; ctx.beginPath(); ctx.moveTo(legendX+80, legendY); ctx.lineTo(legendX+96, legendY); ctx.stroke();
      ctx.fillText('Est. Value', legendX+102, legendY+4);

      const last = series.at(-1);
      byId('chartSummary').textContent = `Cumulative spend ${USD.format(last.spend)} vs. estimated value ${USD.format(last.est)} (Œî ${USD.format(last.est - last.spend)})`;
    }

    function addSampleStamp(){
      const sample = {
        id: crypto.randomUUID(),
        addedAt: Date.now(),
        year: 1959,
        faceValue: 3.00,
        price: 12.00,
        estValue: 25.00,
        purchaseDate: new Date().toISOString().slice(0,10),
        condition: 'Mint',
        signatureType: '',
        acquisition: 'Dealer / Show',
        artist: 'Maynard Reece',
        species: 'King Eiders',
        scott: 'RW26',
        platePos: '',
        notes: 'Sample entry. You can edit or delete me anytime.'
      };
      put('stamps', sample).then(()=>{ renderCollection(); renderChart();
      // If first run (no stamps), show onboarding
      getAll('stamps').then(list => { if (!list || list.length === 0) { byId('firstRunDialog')?.showModal(); } }); byId('firstRunDialog')?.close(); toast('Sample added ‚úÖ'); });
    }

    // Buy Panel & Toast
    function openBuyPanel(){ byId('buyDialog').showModal(); }
    function toast(msg){ const t=byId('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._to); t._to=setTimeout(()=> t.style.display='none', 2000); }

    (async function init(){ await openDB(); await tryLoadExternalCatalog(); renderCollection(); renderChart();
      // If first run (no stamps), show onboarding
      getAll('stamps').then(list => { if (!list || list.length === 0) { byId('firstRunDialog')?.showModal(); } }); const yInit = Number(byId('year')?.value); if (yInit) applyAutofillForYear(yInit);
// Splash behavior
const showSplash = localStorage.getItem('showSplash') !== 'false';
if (localStorage.getItem('startOnMenu') === null) localStorage.setItem('startOnMenu','true');
if (showSplash) {
  const s = byId('splash'); setTimeout(()=>{ s.style.opacity='0'; setTimeout(()=> s.style.display='none', 350); }, 900);
} else { byId('splash').style.display='none'; }
// Menu button
byId('menuBtn')?.addEventListener('click', ()=> byId('menuDialog').showModal());
// Start on menu for small screens
if (matchMedia('(max-width: 820px)').matches && localStorage.getItem('startOnMenu') === 'true') {
  byId('menuDialog').showModal();
}
document.getElementById('yearNow').textContent = new Date().getFullYear();
route();
if (matchMedia('(max-width: 820px)').matches && localStorage.getItem('startOnMenu') === 'true') {
  const h = document.getElementById('homeMenu'); if (h) { window.scrollTo({top: h.getBoundingClientRect().top + window.scrollY - 10, behavior: 'smooth'}); }
}
})();
  </script>

  <script>
    // Splash safety fallback: hide no matter what after 1500ms
    (function(){
      const s = document.getElementById('splash');
      if (!s) return;
      setTimeout(()=>{ s.style.opacity='0'; setTimeout(()=> s.style.display='none', 350); }, 1200);
    document.getElementById('yearNow').textContent = new Date().getFullYear();
route();
if (matchMedia('(max-width: 820px)').matches && localStorage.getItem('startOnMenu') === 'true') {
  const h = document.getElementById('homeMenu'); if (h) { window.scrollTo({top: h.getBoundingClientRect().top + window.scrollY - 10, behavior: 'smooth'}); }
}
})();
  </script>
</body>
</html>
